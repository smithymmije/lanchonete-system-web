<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acompanhar Pedido - Lanchonete</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .status-box { padding: 40px; border-radius: 15px; background: #f8f9fa; border: 2px solid #dc3545; }
        .step-active { color: #dc3545; font-weight: bold; }
    </style>
</head>
<body class="bg-light">
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8 text-center status-box shadow">
                <h2 class="mb-4">Status do seu Pedido</h2>
                <div id="loading" class="spinner-border text-danger mb-3"></div>
                
                <h1 id="statusTexto" class="display-4 text-danger mb-4">Carregando...</h1>
                
                <div class="progress mb-4" style="height: 30px;">
                    <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-danger" style="width: 20%"></div>
                </div>

                <div class="row text-muted">
                    <div class="col" id="step-aguardando">ğŸ•’ Pedido Recebido</div>
                    <div class="col" id="step-pago">ğŸ’° Pago</div>
                    <div class="col" id="step-preparando">ğŸ” Preparando</div>
                    <div class="col" id="step-pronto">âœ… Pronto!</div>
                </div>

                <hr class="my-4">
                <a href="index.html" class="btn btn-outline-secondary">Voltar ao CardÃ¡pio</a>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
    <script>
        //const API_URL = 'http://localhost:4000/api';
        const API_URL = 'https://lanchonete-system-web-backend.onrender.com/api';
        const urlParams = new URLSearchParams(window.location.search);
        const pedidoId = urlParams.get('id');
        let socket = null;

        const statusMap = {
            'aguardando_pagamento': { texto: 'Aguardando Pagamento', progresso: 20 },
            'pago': { texto: 'Pagamento Confirmado', progresso: 45 },
            'preparando': { texto: 'Preparando seu Lanche', progresso: 70 },
            'pronto': { texto: 'Pedido Pronto!', progresso: 100 },
            'entregue': { texto: 'Pedido Entregue', progresso: 100 }
        };

        async function buscarStatusInicial() {
            try {
                // Rota que busca os dados do pedido pelo link de acompanhamento
                const res = await fetch(`${API_URL}/pedidos/status/${pedidoId}`);
                const data = await res.json();
                
                if (res.ok) {
                    atualizarInterface(data.status);
                    conectarSocket();
                } else {
                    document.getElementById('statusTexto').textContent = "Pedido nÃ£o encontrado";
                }
            } catch (err) {
                console.error(err);
            } finally {
                document.getElementById('loading').remove();
            }
        }

        function atualizarInterface(status) {
            const info = statusMap[status] || { texto: status, progresso: 0 };
            document.getElementById('statusTexto').textContent = info.texto;
            document.getElementById('progressBar').style.width = info.progresso + '%';
            
            // Destaca o passo atual
            document.querySelectorAll('.col').forEach(el => el.classList.remove('step-active'));
            const stepId = `step-${status === 'aguardando_pagamento' ? 'aguardando' : status}`;
            const stepEl = document.getElementById(stepId);
            if (stepEl) stepEl.classList.add('step-active');
        }

        function conectarSocket() {
            //socket = io('http://localhost:4000');
            socket = io('https://lanchonete-system-web-backend.onrender.com');
            socket.emit('join-pedido', pedidoId);
            
            socket.on('statusUpdate', (data) => {
                atualizarInterface(data.status);
            });
        }

        if (pedidoId) {
            buscarStatusInicial();
        } else {
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>